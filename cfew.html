<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA | –ê–Ω–æ–Ω–∏–º–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    
    <!-- Tailwind CSS (Stable v3) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        dark: '#0f172a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'pop-in': 'popIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Aurora Background Effect */
        .aurora-container {
            position: absolute;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: #0f172a;
        }
        .aurora-blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.4;
            animation: blob-float 20s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #4c1d95; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #0c4a6e; animation-delay: -5s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #831843; animation-delay: -10s; }

        @keyframes blob-float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(20px, -20px) scale(1.1); }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-strong {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Message Bubbles */
        .msg-me {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        .msg-other {
            background: #1e293b;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Custom Range Input */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px; width: 12px;
            border-radius: 50%;
            background: #fff;
            margin-top: -5px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px;
            background: rgba(255,255,255,0.3);
        }

        .stealth-blur-active {
            filter: blur(15px) grayscale(100%);
        }
    </style>
</head>
<body class="h-screen w-screen text-slate-100 selection:bg-violet-500/30">

    <!-- App Root -->
    <div id="app" class="h-full w-full relative z-10 transition-all duration-300">
        <!-- Content injected by JS -->
    </div>

    <!-- Overlays -->
    <div id="modal-root" class="fixed inset-0 z-[100] pointer-events-none flex items-center justify-center"></div>
    <div id="toast-root" class="fixed top-6 right-6 z-[110] flex flex-col gap-3 pointer-events-none"></div>
    <div id="context-menu-root" class="fixed z-[90] pointer-events-none"></div>

    <!-- Stealth Overlay -->
    <div id="stealth-overlay" class="fixed inset-0 z-[200] pointer-events-none opacity-0 bg-slate-950/90 flex flex-col items-center justify-center transition-opacity duration-300 backdrop-blur-xl">
        <i class="ph ph-eye-slash text-6xl text-violet-500 mb-4 animate-pulse"></i>
        <h2 class="text-2xl font-bold">AURA Protected</h2>
    </div>

    <!-- Error/Reset Fallback (Hidden by default) -->
    <button id="hard-reset-btn" onclick="hardReset()" class="fixed bottom-2 right-2 z-[9999] text-[10px] text-slate-700 hover:text-red-500 opacity-50 hover:opacity-100 p-2">
        RESET APP
    </button>

    <script>
        /**
         * AURA CORE SYSTEM
         * Stable Version 4.0
         */

        // --- CONSTANTS ---
        const DB_KEY = 'aura_db_v4';
        const SESSION_KEY = 'aura_session_v4';
        const SETTINGS_KEY = 'aura_settings_v4';

        // --- STATE MANAGEMENT ---
        const state = {
            user: null,
            settings: { stealthMode: true, sounds: true },
            view: 'landing', // landing, auth-login, auth-reg, app
            activeChatId: null,
            isSidebarOpen: true,
            replyMsg: null,
            editMsg: null,
            searchQuery: '', // Global search
            chatSearchQuery: '', // In-chat search
            isChatSearchOpen: false,
            audioCurrent: null
        };

        const db = {
            data: { users: [], chats: [], messages: [] },
            
            init() {
                try {
                    const raw = localStorage.getItem(DB_KEY);
                    if (raw) {
                        this.data = JSON.parse(raw);
                        // Validate structure
                        if (!Array.isArray(this.data.users)) this.data.users = [];
                        if (!Array.isArray(this.data.chats)) this.data.chats = [];
                        if (!Array.isArray(this.data.messages)) this.data.messages = [];
                    } else {
                        this.seed();
                    }
                } catch (e) {
                    console.error("DB Corrupt, resetting", e);
                    this.seed();
                }
            },

            save() {
                try {
                    // Basic cleanup if too big (Simulate simple LRU)
                    if (JSON.stringify(this.data).length > 4500000) { 
                        this.data.messages = this.data.messages.slice(-200); // Keep last 200 msgs globally
                        toast('–ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞ (–ª–∏–º–∏—Ç –±—Ä–∞—É–∑–µ—Ä–∞)', 'info');
                    }
                    localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                } catch (e) {
                    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ü–∞–º—è—Ç—å –ø–æ–ª–Ω–∞.', 'error');
                }
            },

            seed() {
                this.data = {
                    users: [{
                        id: 'bot', nick: 'AuraBot', status: 'AI Assistant', avatar: null, online: true
                    }],
                    chats: [],
                    messages: []
                };
                this.save();
            }
        };

        // --- UTILS ---
        const u = {
            id: () => Math.random().toString(36).substr(2, 9),
            time: (ts) => new Date(ts).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
            date: (ts) => new Date(ts).toLocaleDateString('ru-RU'),
            avatar: (name) => {
                const colors = ['bg-gradient-to-br from-rose-400 to-orange-300', 'bg-gradient-to-br from-violet-400 to-indigo-400', 'bg-gradient-to-br from-emerald-400 to-cyan-400', 'bg-gradient-to-br from-blue-400 to-sky-300'];
                const idx = name.length % colors.length;
                return `<div class="w-full h-full ${colors[idx]} flex items-center justify-center text-white font-bold text-sm select-none">${name.substring(0,2).toUpperCase()}</div>`;
            },
            md: (txt) => {
                if(!txt) return '';
                return txt
                    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                    .replace(/\*(.*?)\*/g, '<i>$1</i>')
                    .replace(/`(.*?)`/g, '<code class="bg-black/30 rounded px-1 text-xs font-mono">$1</code>')
                    .replace(/~(.*?)~/g, '<span class="line-through opacity-70">$1</span>');
            }
        };

        // --- CORE ACTIONS ---
        function initApp() {
            db.init();
            
            // Load Session
            try {
                const s = localStorage.getItem(SESSION_KEY);
                if (s) state.user = JSON.parse(s);
                
                const set = localStorage.getItem(SETTINGS_KEY);
                if (set) state.settings = { ...state.settings, ...JSON.parse(set) };
            } catch (e) {
                localStorage.removeItem(SESSION_KEY);
            }

            // Route
            if (state.user) {
                // Verify user still exists in DB
                const exists = db.data.users.find(u => u.id === state.user.id);
                if(exists) {
                    state.view = 'app';
                    // Update last seen
                    exists.lastSeen = Date.now();
                    exists.online = true;
                    db.save();
                } else {
                    logout();
                }
            } else {
                state.view = 'landing';
            }

            render();
            startClock();
        }

        function hardReset() {
            if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏ –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- AUTH ---
        function login(nick, pass) {
            const u = db.data.users.find(x => x.nick.toLowerCase() === nick.toLowerCase() && x.pass === btoa(pass));
            if (!u) return toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
            
            u.online = true;
            state.user = u;
            localStorage.setItem(SESSION_KEY, JSON.stringify(u));
            db.save();
            state.view = 'app';
            render();
            toast(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${u.nick}`);
        }

        function register(nick, pass) {
            if (nick.length < 3) return toast('–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', 'error');
            if (pass.length < 4) return toast('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π', 'error');
            if (db.data.users.find(x => x.nick.toLowerCase() === nick.toLowerCase())) return toast('–ù–∏–∫ –∑–∞–Ω—è—Ç', 'error');

            const newUser = {
                id: u.id(),
                nick,
                pass: btoa(pass),
                status: '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                avatar: null,
                theme: 'dark',
                online: true,
                createdAt: Date.now()
            };
            
            db.data.users.push(newUser);
            
            // Welcome msg from bot
            const chat = createChatLogic([newUser.id, 'bot']);
            addMessageLogic(chat.id, 'bot', 'text', `–ü—Ä–∏–≤–µ—Ç, **${nick}**! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AURA. –ó–¥–µ—Å—å –ø–æ–ª–Ω–∞—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–≤–æ–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.`);

            state.user = newUser;
            localStorage.setItem(SESSION_KEY, JSON.stringify(newUser));
            db.save();
            state.view = 'app';
            render();
        }

        function logout() {
            if(state.user) {
                const usr = db.data.users.find(u => u.id === state.user.id);
                if(usr) usr.online = false;
                db.save();
            }
            state.user = null;
            state.activeChatId = null;
            localStorage.removeItem(SESSION_KEY);
            state.view = 'landing';
            render();
        }

        // --- CHAT LOGIC ---
        function createChatLogic(members, type='private', title=null) {
            // Check existing private
            if (type === 'private') {
                const exist = db.data.chats.find(c => c.type === 'private' && c.members.includes(members[0]) && c.members.includes(members[1]));
                if (exist) return exist;
            }
            const chat = {
                id: u.id(),
                type,
                members,
                title,
                pinnedId: null,
                createdAt: Date.now(),
                updatedAt: Date.now()
            };
            db.data.chats.push(chat);
            db.save();
            return chat;
        }

        function addMessageLogic(chatId, senderId, type, content, media=null, replyTo=null) {
            const msg = {
                id: u.id(),
                chatId,
                senderId,
                type,
                content,
                media,
                replyTo,
                createdAt: Date.now(),
                reactions: {},
                isEdited: false,
                isDeleted: false,
                read: false
            };
            db.data.messages.push(msg);
            
            const c = db.data.chats.find(x => x.id === chatId);
            if (c) c.updatedAt = Date.now();
            
            db.save();
            return msg;
        }

        // --- RENDERERS ---
        
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; // clear

            if (state.view === 'landing') {
                app.innerHTML = renderLanding();
            } else if (state.view === 'auth') {
                app.innerHTML = renderAuth();
            } else if (state.view === 'app') {
                app.innerHTML = renderApp();
                scrollToBottom();
            }
        }

        const renderLanding = () => `
            <div class="aurora-container">
                <div class="aurora-blob blob-1"></div>
                <div class="aurora-blob blob-2"></div>
                <div class="aurora-blob blob-3"></div>
            </div>
            <div class="relative h-full flex flex-col items-center justify-center p-6 text-center z-10">
                <div class="mb-8 p-6 bg-white/5 rounded-3xl backdrop-blur-xl border border-white/10 shadow-2xl animate-float">
                    <i class="ph ph-mask-happy text-6xl text-violet-400"></i>
                </div>
                <h1 class="text-6xl md:text-8xl font-black tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-r from-violet-400 via-fuchsia-300 to-white animate-fade-in">AURA</h1>
                <p class="text-slate-400 text-lg md:text-xl max-w-xl mb-12 animate-fade-in" style="animation-delay: 0.1s">
                    –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å. –ù–∏–∫–∞–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤. <br> –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Ç–æ–ª—å–∫–æ –≤–∞–º.
                </p>
                <div class="flex gap-4 animate-fade-in" style="animation-delay: 0.2s">
                    <button onclick="state.view='auth'; state.authMode='login'; render()" class="px-8 py-4 bg-white text-slate-900 rounded-xl font-bold hover:scale-105 transition shadow-lg shadow-white/10">–í–æ–π—Ç–∏</button>
                    <button onclick="state.view='auth'; state.authMode='reg'; render()" class="px-8 py-4 bg-white/10 text-white border border-white/10 rounded-xl font-bold hover:bg-white/20 transition backdrop-blur-md">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </div>
            </div>
        `;

        const renderAuth = () => {
            const isLogin = state.authMode === 'login';
            return `
            <div class="aurora-container">
                <div class="aurora-blob blob-1"></div>
                <div class="aurora-blob blob-2"></div>
            </div>
            <div class="relative h-full flex items-center justify-center p-4">
                <button onclick="state.view='landing'; render()" class="absolute top-8 left-8 text-white/50 hover:text-white transition"><i class="ph ph-arrow-left text-3xl"></i></button>
                
                <div class="glass w-full max-w-md p-8 rounded-3xl shadow-2xl animate-pop-in">
                    <h2 class="text-3xl font-bold mb-2">${isLogin ? '–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º' : '–ù–æ–≤–∞—è –ª–∏—á–Ω–æ—Å—Ç—å'}</h2>
                    <p class="text-slate-400 mb-8 text-sm">${isLogin ? '–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞' : '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Å–µ–≤–¥–æ–Ω–∏–º'}</p>
                    
                    <form onsubmit="event.preventDefault(); ${isLogin ? 'login' : 'register'}(this.nick.value, this.pass.value)" class="space-y-4">
                        <div>
                            <label class="text-xs uppercase font-bold text-slate-500 ml-1">–ù–∏–∫–Ω–µ–π–º</label>
                            <input name="nick" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 mt-1 focus:ring-2 focus:ring-violet-500 outline-none transition text-white" placeholder="Ghost" required>
                        </div>
                        <div>
                            <label class="text-xs uppercase font-bold text-slate-500 ml-1">–ü–∞—Ä–æ–ª—å</label>
                            <input name="pass" type="password" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 mt-1 focus:ring-2 focus:ring-violet-500 outline-none transition text-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        <button class="w-full py-4 bg-violet-600 hover:bg-violet-500 text-white rounded-xl font-bold shadow-lg shadow-violet-600/30 transition mt-4">
                            ${isLogin ? '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'}
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button onclick="state.authMode='${isLogin ? 'reg' : 'login'}'; render()" class="text-sm text-slate-400 hover:text-white underline decoration-transparent hover:decoration-white transition">
                            ${isLogin ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?'}
                        </button>
                    </div>
                </div>
            </div>
            `;
        };

        const renderApp = () => {
            const user = state.user;
            const chats = db.data.chats
                .filter(c => c.members.includes(user.id))
                .sort((a,b) => b.updatedAt - a.updatedAt);
            
            const activeChat = state.activeChatId ? db.data.chats.find(c => c.id === state.activeChatId) : null;
            
            // Validate active chat still exists (deleted case)
            if (state.activeChatId && !activeChat) {
                state.activeChatId = null;
                return render();
            }

            // --- Sidebar List ---
            const chatListHtml = chats.length ? chats.map(c => {
                const otherId = c.members.find(m => m !== user.id);
                const other = db.data.users.find(u => u.id === otherId) || { nick: 'Unknown', id: 'deleted' };
                const lastMsg = db.data.messages.filter(m => m.chatId === c.id && !m.isDeleted).pop();
                
                // Search filter
                if (state.searchQuery && !other.nick.toLowerCase().includes(state.searchQuery.toLowerCase())) return '';

                const isActive = c.id === state.activeChatId;
                
                return `
                <div onclick="selectChat('${c.id}')" class="p-3 rounded-xl flex items-center gap-3 cursor-pointer transition mb-1 ${isActive ? 'bg-violet-600/20 border border-violet-500/30' : 'hover:bg-white/5 border border-transparent'}">
                    <div class="w-12 h-12 rounded-full overflow-hidden shrink-0 relative">
                        ${other.avatar ? `<img src="${other.avatar}" class="w-full h-full object-cover">` : u.avatar(other.nick)}
                        ${other.online ? `<div class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 rounded-full border-2 border-slate-900"></div>` : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-semibold truncate text-sm text-slate-200">${other.nick}</h3>
                            <span class="text-[10px] text-slate-500">${lastMsg ? u.time(lastMsg.createdAt) : ''}</span>
                        </div>
                        <p class="text-xs text-slate-400 truncate opacity-80">
                            ${lastMsg ? (lastMsg.senderId === user.id ? '<span class="text-violet-400">–í—ã: </span>' : '') + getMsgPreview(lastMsg) : '<span class="italic text-slate-600">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</span>'}
                        </p>
                    </div>
                </div>`;
            }).join('') : `<div class="p-10 text-center opacity-30 text-sm">–ù–µ—Ç —á–∞—Ç–æ–≤</div>`;

            // --- Chat View ---
            let chatViewHtml = '';
            if (activeChat) {
                const otherId = activeChat.members.find(m => m !== user.id);
                const other = db.data.users.find(u => u.id === otherId) || { nick: 'Deleted', online: false };
                
                // Filter messages
                let msgs = db.data.messages.filter(m => m.chatId === activeChat.id && !m.isDeleted);
                if (state.chatSearchQuery) {
                    msgs = msgs.filter(m => m.content && m.content.toLowerCase().includes(state.chatSearchQuery.toLowerCase()));
                }

                const msgsHtml = msgs.map(m => renderMessage(m, user.id)).join('');

                // Pinned Message
                let pinnedHtml = '';
                if(activeChat.pinnedId) {
                    const pm = db.data.messages.find(x => x.id === activeChat.pinnedId);
                    if(pm) {
                        pinnedHtml = `
                        <div class="glass-strong px-4 py-2 flex justify-between items-center text-xs animate-fade-in relative z-20 cursor-pointer" onclick="scrollToMsg('${pm.id}')">
                            <div class="flex gap-2 items-center">
                                <div class="w-1 h-8 bg-violet-500 rounded-full"></div>
                                <div>
                                    <div class="font-bold text-violet-400">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                                    <div class="truncate max-w-[200px] text-slate-300 opacity-80">${getMsgPreview(pm)}</div>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); pinMsg(null)" class="p-2 hover:bg-white/10 rounded-full"><i class="ph ph-x"></i></button>
                        </div>`;
                    }
                }

                chatViewHtml = `
                    <div class="flex flex-col h-full relative">
                        <!-- Header -->
                        <div class="h-16 shrink-0 glass-strong flex items-center justify-between px-4 z-30">
                            <div class="flex items-center gap-3">
                                <button class="md:hidden p-2 -ml-2 text-slate-400" onclick="toggleSidebar()"><i class="ph ph-arrow-left text-xl"></i></button>
                                <div class="w-10 h-10 rounded-full overflow-hidden bg-slate-800">${other.avatar ? `<img src="${other.avatar}">` : u.avatar(other.nick)}</div>
                                <div>
                                    <div class="font-bold text-sm leading-tight">${other.nick}</div>
                                    <div class="text-[10px] ${other.online ? 'text-emerald-400' : 'text-slate-500'}">${other.online ? '–û–Ω–ª–∞–π–Ω' : '–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ'}</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleChatSearch()" class="p-2 hover:bg-white/10 rounded-full ${state.isChatSearchOpen ? 'text-violet-400 bg-white/5' : 'text-slate-400'}"><i class="ph ph-magnifying-glass text-lg"></i></button>
                                <button onclick="deleteChat()" class="p-2 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-full"><i class="ph ph-trash text-lg"></i></button>
                            </div>
                        </div>

                        <!-- Chat Search Bar -->
                        ${state.isChatSearchOpen ? `
                            <div class="p-2 bg-slate-900 border-b border-white/10 animate-fade-in z-20">
                                <input type="text" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-1.5 text-sm outline-none" 
                                    oninput="state.chatSearchQuery = this.value; render()" value="${state.chatSearchQuery}" autofocus>
                            </div>
                        ` : ''}

                        ${pinnedHtml}

                        <!-- Messages Area -->
                        <div id="msg-container" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth relative">
                            <div class="absolute inset-0 pointer-events-none bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                            ${msgsHtml}
                        </div>

                        <!-- Input Area -->
                        <div class="shrink-0 p-3 bg-slate-900 border-t border-white/10 relative z-30">
                            <!-- Reply/Edit Context -->
                            ${state.replyMsg || state.editMsg ? `
                                <div class="absolute bottom-full left-0 right-0 glass-strong p-2 flex justify-between items-center text-xs border-t border-white/5">
                                    <div class="pl-3 border-l-2 ${state.editMsg ? 'border-yellow-500' : 'border-violet-500'}">
                                        <div class="font-bold ${state.editMsg ? 'text-yellow-400' : 'text-violet-400'}">
                                            ${state.editMsg ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–û—Ç–≤–µ—Ç'}
                                        </div>
                                        <div class="truncate max-w-xs opacity-70">
                                            ${state.editMsg ? state.editMsg.content : getMsgPreview(state.replyMsg)}
                                        </div>
                                    </div>
                                    <button onclick="cancelInputState()" class="p-2 hover:bg-white/10 rounded-full"><i class="ph ph-x"></i></button>
                                </div>
                            ` : ''}

                            <form onsubmit="handleSend(event)" class="flex items-end gap-2 max-w-4xl mx-auto">
                                <button type="button" onclick="document.getElementById('file-input').click()" class="p-3 text-slate-400 hover:text-violet-400 hover:bg-slate-800 rounded-full transition"><i class="ph ph-paperclip text-xl"></i></button>
                                <input type="file" id="file-input" class="hidden" onchange="handleFile(event)">
                                
                                <div class="flex-1 bg-slate-800 rounded-2xl flex items-center border border-slate-700 focus-within:border-violet-500 transition px-2">
                                    <input id="msg-input" type="text" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full bg-transparent border-none text-slate-100 p-3 focus:ring-0 placeholder-slate-500" value="${state.editMsg ? state.editMsg.content : ''}">
                                    <button type="button" class="p-2 text-slate-500 hover:text-white" title="Markdown: **b**, *i*, &#96;code&#96;" onclick="insertMd()"><i class="ph ph-text-aa"></i></button>
                                </div>

                                <button type="button" onmousedown="startRec()" onmouseup="stopRec()" id="mic-btn" class="p-3 text-slate-400 hover:text-red-500 hover:bg-red-500/10 rounded-full transition relative group">
                                    <i class="ph ph-microphone text-xl"></i>
                                    <div id="rec-dot" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>
                                </button>
                                
                                <button type="submit" class="p-3 bg-violet-600 hover:bg-violet-500 text-white rounded-full shadow-lg shadow-violet-500/20 transition transform active:scale-95">
                                    <i class="ph ${state.editMsg ? 'ph-check' : 'ph-paper-plane-right'} text-xl"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            } else {
                chatViewHtml = `
                    <div class="h-full flex flex-col items-center justify-center text-slate-500 opacity-60">
                        <i class="ph ph-chats-teardrop text-8xl mb-4"></i>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
                    </div>
                `;
            }

            // Main Layout
            return `
                <div class="flex h-full w-full bg-slate-950 overflow-hidden">
                    <!-- Sidebar -->
                    <div class="${state.isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 absolute md:relative z-40 w-full md:w-80 lg:w-96 h-full glass border-r-0 md:border-r border-slate-800 transition-transform duration-300 flex flex-col bg-slate-900/95 md:bg-transparent">
                        <div class="p-4 flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="showProfile()">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-violet-600 to-indigo-500 flex items-center justify-center font-bold shadow-lg">
                                    ${state.user.avatar ? `<img src="${state.user.avatar}" class="rounded-full">` : state.user.nick[0].toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-white">${state.user.nick}</div>
                                    <div class="text-[10px] text-emerald-400 font-bold uppercase tracking-wider">Online</div>
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="showNewChat()" class="p-2 hover:bg-white/10 rounded-full transition text-slate-400 hover:text-white"><i class="ph ph-plus text-xl"></i></button>
                                <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-full transition text-slate-400 hover:text-white"><i class="ph ph-gear text-xl"></i></button>
                            </div>
                        </div>
                        <div class="px-4 pb-2 shrink-0">
                            <div class="bg-slate-900/50 border border-slate-700/50 rounded-xl flex items-center px-3 py-2">
                                <i class="ph ph-magnifying-glass text-slate-500 mr-2"></i>
                                <input type="text" placeholder="–ü–æ–∏—Å–∫..." class="bg-transparent w-full text-sm outline-none text-slate-300 placeholder-slate-600" oninput="state.searchQuery=this.value; render()">
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto px-2 space-y-1 pb-2">
                            ${chatListHtml}
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="flex-1 relative bg-slate-950 w-full">
                         ${chatViewHtml}
                    </div>
                </div>
            `;
        };

        function renderMessage(m, myId) {
            const isMe = m.senderId === myId;
            const sender = db.data.users.find(u => u.id === m.senderId);
            const date = new Date(m.createdAt);

            let contentHtml = '';
            if (m.type === 'text') contentHtml = `<div class="whitespace-pre-wrap leading-relaxed break-words">${u.md(m.content)}</div>`;
            else if (m.type === 'image') contentHtml = `<img src="${m.media}" class="rounded-lg max-h-[300px] object-cover cursor-zoom-in border border-white/10 hover:opacity-90 transition" onclick="showMedia('${m.media}')">`;
            else if (m.type === 'voice') contentHtml = renderAudioPlayer(m.media, m.id);

            // Reply UI
            let replyHtml = '';
            if (m.replyTo) {
                const rm = db.data.messages.find(x => x.id === m.replyTo);
                if(rm) {
                    const rSender = db.data.users.find(u => u.id === rm.senderId)?.nick || '...';
                    replyHtml = `<div class="text-xs mb-1 pl-2 border-l-2 border-white/30 opacity-70 cursor-pointer hover:underline" onclick="scrollToMsg('${rm.id}')"><b>${rSender}</b>: ${getMsgPreview(rm)}</div>`;
                }
            }

            return `
            <div id="msg-${m.id}" class="flex w-full mb-2 ${isMe ? 'justify-end' : 'justify-start'} group relative animate-fade-in" oncontextmenu="handleCtx(event, '${m.id}', ${isMe})">
                <div class="max-w-[85%] md:max-w-[70%]">
                    <div class="p-3 ${isMe ? 'msg-me text-white' : 'msg-other text-slate-200'} relative">
                        ${replyHtml}
                        ${contentHtml}
                        <div class="flex justify-end items-center gap-1 mt-1 opacity-60 select-none">
                            ${m.isEdited ? '<i class="ph ph-pencil-simple text-[10px]"></i>' : ''}
                            <span class="text-[10px] font-mono">${u.time(date)}</span>
                            ${isMe ? '<i class="ph ph-checks text-[12px] text-sky-200"></i>' : ''}
                        </div>
                        
                        <!-- Reactions -->
                        ${Object.keys(m.reactions).length ? `
                        <div class="absolute -bottom-3 ${isMe ? 'right-0' : 'left-0'} flex gap-1 z-10">
                            ${Object.entries(m.reactions).map(([uid, emoji]) => `<div class="bg-slate-800 border border-slate-600 text-xs px-1.5 rounded-full shadow-sm">${emoji}</div>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <button class="md:hidden opacity-0 group-hover:opacity-50 px-2 text-slate-500" onclick="handleCtx(event, '${m.id}', ${isMe})"><i class="ph ph-dots-three-vertical"></i></button>
            </div>`;
        }

        function renderAudioPlayer(src, id) {
            return `
            <div class="flex items-center gap-3 min-w-[200px] select-none">
                <button id="btn-${id}" onclick="playAudio('${src}', '${id}')" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition shadow-sm shrink-0">
                    <i class="ph ph-play-fill text-xl"></i>
                </button>
                <div class="flex-1 flex flex-col justify-center h-full gap-1">
                     <input id="range-${id}" type="range" value="0" min="0" max="100" class="w-full h-1" oninput="seekAudio('${id}', this.value)" onmousedown="window.isDragging=true" onmouseup="window.isDragging=false">
                     <div class="flex justify-between text-[10px] font-mono opacity-80">
                        <span>VOICE</span>
                        <span id="time-${id}">0:00</span>
                     </div>
                </div>
            </div>`;
        }

        // --- AUDIO ENGINE ---
        let currentAudio = null;
        let currentAudioId = null;

        function playAudio(src, id) {
            const btn = document.getElementById(`btn-${id}`);
            const icon = btn.querySelector('i');
            const range = document.getElementById(`range-${id}`);
            const timer = document.getElementById(`time-${id}`);

            if (currentAudio && currentAudioId === id) {
                // Toggle pause
                if (currentAudio.paused) {
                    currentAudio.play();
                    icon.classList.replace('ph-play-fill', 'ph-pause-fill');
                } else {
                    currentAudio.pause();
                    icon.classList.replace('ph-pause-fill', 'ph-play-fill');
                }
                return;
            }

            // Stop previous
            if (currentAudio) {
                currentAudio.pause();
                const prevBtn = document.getElementById(`btn-${currentAudioId}`);
                if (prevBtn) prevBtn.querySelector('i').classList.replace('ph-pause-fill', 'ph-play-fill');
            }

            // New Audio
            currentAudio = new Audio(src);
            currentAudioId = id;
            currentAudio.play();
            icon.classList.replace('ph-play-fill', 'ph-pause-fill');

            currentAudio.ontimeupdate = () => {
                if (!window.isDragging && range) {
                    const pct = (currentAudio.currentTime / currentAudio.duration) * 100;
                    range.value = pct || 0;
                    const m = Math.floor(currentAudio.currentTime / 60);
                    const s = Math.floor(currentAudio.currentTime % 60);
                    if(timer) timer.innerText = `${m}:${s<10?'0'+s:s}`;
                }
            };

            currentAudio.onended = () => {
                icon.classList.replace('ph-pause-fill', 'ph-play-fill');
                if(range) range.value = 0;
                currentAudio = null;
                currentAudioId = null;
            };
        }

        function seekAudio(id, val) {
            if (currentAudio && currentAudioId === id) {
                const time = (val / 100) * currentAudio.duration;
                currentAudio.currentTime = time;
            }
        }

        // --- EVENTS & ACTIONS ---

        function handleSend(e) {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if (!val) return;

            if (state.editMsg) {
                const m = db.data.messages.find(x => x.id === state.editMsg.id);
                if (m) {
                    m.content = val;
                    m.isEdited = true;
                    db.save();
                }
                state.editMsg = null;
            } else {
                addMessageLogic(state.activeChatId, state.user.id, 'text', val, null, state.replyMsg?.id);
                botReply(state.activeChatId);
            }
            
            input.value = '';
            state.replyMsg = null;
            render();
            scrollToBottom();
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return toast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>5MB)', 'error');

            const reader = new FileReader();
            reader.onload = (ev) => {
                const type = file.type.startsWith('image/') ? 'image' : 'file'; // Simplified for SPA
                addMessageLogic(state.activeChatId, state.user.id, type, file.name, ev.target.result);
                botReply(state.activeChatId);
                render();
                scrollToBottom();
            };
            reader.readAsDataURL(file);
        }

        // Recording
        let mediaRec;
        let chunks = [];
        
        function startRec() {
            if (!navigator.mediaDevices) return toast('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω—É–∂–µ–Ω HTTPS/localhost)', 'error');
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRec = new MediaRecorder(stream);
                    mediaRec.start();
                    document.getElementById('rec-dot').classList.remove('hidden');
                    chunks = [];
                    mediaRec.ondataavailable = e => chunks.push(e.data);
                    mediaRec.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onload = r => {
                            addMessageLogic(state.activeChatId, state.user.id, 'voice', 'Golosovoe', r.target.result);
                            render(); scrollToBottom();
                        };
                        reader.readAsDataURL(blob);
                    };
                })
                .catch(err => toast('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error'));
        }

        function stopRec() {
            if (mediaRec && mediaRec.state !== 'inactive') {
                mediaRec.stop();
                document.getElementById('rec-dot')?.classList.add('hidden');
            }
        }

        function deleteChat() {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è?')) return;
            db.data.chats = db.data.chats.filter(c => c.id !== state.activeChatId);
            db.data.messages = db.data.messages.filter(m => m.chatId !== state.activeChatId);
            db.save();
            state.activeChatId = null;
            render();
        }

        // Context Menu
        function handleCtx(e, msgId, isMe) {
            e.preventDefault();
            const root = document.getElementById('context-menu-root');
            const x = Math.min(e.clientX, window.innerWidth - 200);
            const y = Math.min(e.clientY, window.innerHeight - 250);
            
            const m = db.data.messages.find(x => x.id === msgId);
            const pinned = db.data.chats.find(c => c.id === state.activeChatId).pinnedId === msgId;

            root.innerHTML = `
                <div class="absolute bg-slate-800 border border-slate-700 rounded-xl shadow-2xl py-2 w-48 text-sm z-50 flex flex-col overflow-hidden animate-pop-in" style="top:${y}px; left:${x}px">
                    <div class="flex justify-between px-3 py-2 border-b border-white/5 bg-slate-900/50">
                        ${['üëç','‚ù§Ô∏è','üòÇ','üî•'].map(em => `<button onclick="react('${msgId}','${em}')" class="hover:scale-125 transition text-lg">${em}</button>`).join('')}
                    </div>
                    <button onclick="state.replyMsg=db.data.messages.find(m=>m.id=='${msgId}'); render(); closeCtx()" class="text-left px-4 py-3 hover:bg-white/5 flex gap-3 items-center"><i class="ph ph-arrow-u-up-left"></i> –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                    <button onclick="copyTxt('${msgId}'); closeCtx()" class="text-left px-4 py-3 hover:bg-white/5 flex gap-3 items-center"><i class="ph ph-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onclick="pinMsg('${msgId}'); closeCtx()" class="text-left px-4 py-3 hover:bg-white/5 flex gap-3 items-center"><i class="ph ${pinned ? 'ph-push-pin-slash' : 'ph-push-pin'}"></i> ${pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'}</button>
                    ${isMe ? `
                        <div class="h-px bg-white/5 my-1"></div>
                        <button onclick="state.editMsg=db.data.messages.find(m=>m.id=='${msgId}'); render(); closeCtx()" class="text-left px-4 py-3 hover:bg-white/5 flex gap-3 items-center"><i class="ph ph-pencil-simple"></i> –ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button onclick="delMsg('${msgId}'); closeCtx()" class="text-left px-4 py-3 hover:bg-red-500/20 text-red-400 flex gap-3 items-center"><i class="ph ph-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>
                    ` : ''}
                </div>
            `;
            
            // Click outside to close
            const closer = (ev) => {
                if (!root.contains(ev.target)) {
                    closeCtx();
                    document.removeEventListener('mousedown', closer);
                }
            };
            setTimeout(() => document.addEventListener('mousedown', closer), 0);
        }

        function closeCtx() { document.getElementById('context-menu-root').innerHTML = ''; }
        
        function react(id, emoji) {
            const m = db.data.messages.find(x => x.id === id);
            if (m) {
                m.reactions[state.user.id] = emoji;
                db.save();
                render();
            }
            closeCtx();
        }

        function copyTxt(id) {
            const m = db.data.messages.find(x => x.id === id);
            if (m && m.content) {
                navigator.clipboard.writeText(m.content);
                toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
            }
        }

        function pinMsg(id) {
            const c = db.data.chats.find(x => x.id === state.activeChatId);
            if (c) {
                c.pinnedId = c.pinnedId === id ? null : id;
                db.save();
                render();
            }
        }

        function delMsg(id) {
            const m = db.data.messages.find(x => x.id === id);
            if(m) {
                m.isDeleted = true;
                db.save();
                render();
            }
        }

        function cancelInputState() {
            state.editMsg = null;
            state.replyMsg = null;
            render();
        }

        // --- BOT ---
        function botReply(chatId) {
            const chat = db.data.chats.find(c => c.id === chatId);
            if (chat && chat.members.includes('bot')) {
                setTimeout(() => {
                    const phrases = ['–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!', '–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞.', '–Ø –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä–∏–ø—Ç, –Ω–æ —è —É—á—É—Å—å.', '–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ.', 'üëç'];
                    addMessageLogic(chatId, 'bot', 'text', phrases[Math.floor(Math.random()*phrases.length)]);
                    if (state.activeChatId === chatId) { render(); scrollToBottom(); }
                }, 1500);
            }
        }

        // --- HELPERS ---
        function toast(msg, type='info') {
            const el = document.createElement('div');
            el.className = `px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 backdrop-blur-md animate-fade-in border border-white/10 ${type==='error'?'bg-red-500/80':'bg-slate-800/80'}`;
            el.innerHTML = `<span>${msg}</span>`;
            document.getElementById('toast-root').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function getMsgPreview(m) {
            if (!m) return '';
            if (m.type === 'image') return 'üì∑ –§–æ—Ç–æ';
            if (m.type === 'voice') return 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ';
            return m.content;
        }

        function scrollToBottom() {
            setTimeout(() => {
                const c = document.getElementById('msg-container');
                if (c) c.scrollTop = c.scrollHeight;
            }, 50);
        }
        
        function scrollToMsg(id) {
             const el = document.getElementById(`msg-${id}`);
             if(el) {
                 el.scrollIntoView({behavior:'smooth', block:'center'});
                 el.classList.add('bg-violet-500/20', 'transition-colors', 'duration-1000');
                 setTimeout(()=>el.classList.remove('bg-violet-500/20'), 1500);
             } else {
                 toast('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
             }
        }

        function toggleSidebar() { state.isSidebarOpen = !state.isSidebarOpen; render(); }
        function toggleChatSearch() { state.isChatSearchOpen = !state.isChatSearchOpen; if(!state.isChatSearchOpen) state.chatSearchQuery=''; render(); }
        function selectChat(id) { state.activeChatId = id; if(window.innerWidth < 768) state.isSidebarOpen = false; render(); }
        
        // Modals
        function showProfile() {
            const u = state.user;
            document.getElementById('modal-root').innerHTML = `
                <div class="bg-slate-800 p-6 rounded-3xl w-80 shadow-2xl border border-white/10 animate-pop-in pointer-events-auto relative z-[110]">
                    <div class="text-center">
                        <div class="w-24 h-24 rounded-full bg-slate-700 mx-auto mb-4 overflow-hidden border-4 border-slate-600">
                             ${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-violet-600 flex items-center justify-center text-3xl font-bold">${u.nick[0]}</div>`}
                        </div>
                        <h2 class="text-2xl font-bold text-white">${u.nick}</h2>
                        <p class="text-slate-400 text-sm mb-6">${u.status}</p>
                        <button onclick="logout(); document.getElementById('modal-root').innerHTML=''" class="w-full py-2 border border-red-500/50 text-red-400 rounded-xl hover:bg-red-500/10">–í—ã–π—Ç–∏</button>
                    </div>
                    <button onclick="document.getElementById('modal-root').innerHTML=''" class="absolute top-4 right-4"><i class="ph ph-x text-xl"></i></button>
                </div>
            `;
        }

        function showNewChat() {
            document.getElementById('modal-root').innerHTML = `
                <div class="bg-slate-800 p-6 rounded-2xl w-80 shadow-2xl animate-pop-in pointer-events-auto z-[110]">
                    <h3 class="font-bold mb-4">–ù–æ–≤—ã–π —á–∞—Ç</h3>
                    <input id="new-nick" placeholder="–ù–∏–∫–Ω–µ–π–º..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 mb-4 text-white">
                    <button onclick="startChat(document.getElementById('new-nick').value)" class="w-full py-2 bg-violet-600 text-white rounded-lg font-bold">–ù–∞—á–∞—Ç—å</button>
                    <button onclick="document.getElementById('modal-root').innerHTML=''" class="mt-2 w-full text-sm text-slate-500">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            setTimeout(() => document.getElementById('new-nick').focus(), 50);
        }

        function startChat(nick) {
            const target = db.data.users.find(u => u.nick.toLowerCase() === nick.toLowerCase().trim());
            if (!target) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            if (target.id === state.user.id) return toast('–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–µ–±–µ', 'error');
            
            const chat = createChatLogic([state.user.id, target.id]);
            document.getElementById('modal-root').innerHTML = '';
            selectChat(chat.id);
        }

        function showMedia(url) {
            document.getElementById('modal-root').innerHTML = `
                <div class="relative max-w-5xl max-h-[90vh] pointer-events-auto z-[120]">
                    <img src="${url}" class="max-h-[85vh] rounded-lg shadow-2xl bg-black">
                    <button onclick="document.getElementById('modal-root').innerHTML=''" class="absolute -top-10 right-0 text-white"><i class="ph ph-x text-3xl"></i></button>
                </div>
            `;
        }
        
        function showSettings() {
             document.getElementById('modal-root').innerHTML = `
                <div class="bg-slate-800 p-6 rounded-2xl w-80 shadow-2xl animate-pop-in pointer-events-auto z-[110] select-none">
                    <h3 class="font-bold mb-4 text-xl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="space-y-4">
                        <label class="flex justify-between items-center cursor-pointer">
                            <span>–°—Ç–µ–ª—Å-—Ä–µ–∂–∏–º (–ë–ª—é—Ä)</span>
                            <input type="checkbox" ${state.settings.stealthMode ? 'checked' : ''} onchange="state.settings.stealthMode=this.checked; localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings))">
                        </label>
                         <button onclick="hardReset()" class="text-red-400 text-sm mt-4">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button>
                    </div>
                    <button onclick="document.getElementById('modal-root').innerHTML=''" class="mt-6 w-full py-2 bg-slate-700 rounded-lg">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
        }

        // Stealth Mode
        document.addEventListener('visibilitychange', () => {
             if (document.hidden && state.settings.stealthMode && state.user) {
                 document.getElementById('stealth-overlay').classList.remove('opacity-0', 'pointer-events-none');
                 document.title = "Protected";
             } else {
                 document.getElementById('stealth-overlay').classList.add('opacity-0', 'pointer-events-none');
                 document.title = "AURA";
             }
        });

        // Clock
        function startClock() {
            setInterval(() => {
                // Could update 'last seen' here if needed
            }, 60000);
        }
        
        function insertMd() {
            toast('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: **bold**, *italic*, `code`');
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>